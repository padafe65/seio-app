import axios from 'axios';

const API_URL = process.env.REACT_APP_API_URL || "http://localhost:5000";

// Crear una instancia de Axios
const api = axios.create({
  baseURL: API_URL,
  withCredentials: true,
  headers: {
    'Content-Type': 'application/json',
  },
});

// Interceptor para agregar el token de autenticaci√≥n a cada solicitud
api.interceptors.request.use(
  async (config) => {
    console.log('üîë [Axios] Configurando solicitud a:', config.url);
    
    // No modificar la solicitud si es una solicitud de autenticaci√≥n
    if (config.url && (config.url.includes('/api/auth/') || config.url.includes('/login'))) {
      console.log('üîê [Axios] Solicitando autenticaci√≥n, omitiendo token');
      return config;
    }
    
    const token = localStorage.getItem('authToken');
    
    if (token) {
      try {
        // Verificar si el token est√° a punto de expirar (en los pr√≥ximos 5 minutos)
        const tokenPayload = JSON.parse(atob(token.split('.')[1]));
        const now = Date.now() / 1000; // Tiempo actual en segundos
        
        console.log('üîë [Axios] Token expira en:', (tokenPayload.exp - now).toFixed(0), 'segundos');
        
        // Si el token expira en menos de 5 minutos, intentar renovarlo
        if (tokenPayload.exp && (tokenPayload.exp - now) < 300) {
          console.log('üîÑ [Axios] El token est√° a punto de expirar, intentando renovar...');
          // No hacemos nada aqu√≠, dejamos que el interceptor de respuesta maneje la renovaci√≥n
        }
        
        // Agregar el token al encabezado
        config.headers.Authorization = `Bearer ${token}`;
        console.log('üîë [Axios] Token agregado a la solicitud');
        
      } catch (e) {
        console.error('‚ùå [Axios] Error al verificar el token:', e);
        // Si hay un error al verificar el token, lo eliminamos para forzar un nuevo inicio de sesi√≥n
        localStorage.removeItem('authToken');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('user');
        
        // Redirigir al login
        if (window.location.pathname !== '/login') {
          window.location.href = '/login?error=session_expired';
        }
        
        return Promise.reject(new Error('Token inv√°lido'));
      }
    } else {
      console.warn('‚ö†Ô∏è [Axios] No se encontr√≥ token de autenticaci√≥n');
      if (window.location.pathname !== '/login') {
        window.location.href = '/login?error=no_token';
      }
      return Promise.reject(new Error('No autenticado'));
    }
    
    // Agregar encabezados comunes
    config.headers['Content-Type'] = 'application/json';
    config.headers['Accept'] = 'application/json';
    
    return config;
  },
  (error) => {
    console.error('Error en la solicitud:', error);
    return Promise.reject(error);
  }
);

// Interceptor para manejar respuestas de error
export const setupResponseInterceptor = (navigate) => {
  console.log('üîÑ Configurando interceptor de respuestas de Axios');
  
  // Eliminar cualquier interceptor existente para evitar duplicados
  if (api.interceptors.response.handlers) {
    console.log('üßπ Limpiando interceptores de respuesta existentes');
    api.interceptors.response.handlers = [];
  }
  
  return api.interceptors.response.use(
    (response) => {
      // Si la respuesta es exitosa, simplemente la retornamos
      console.log('‚úÖ [Axios] Respuesta exitosa:', {
        url: response.config.url,
        status: response.status,
        data: response.data ? 'Datos recibidos' : 'Sin datos'
      });
      return response;
    },
    async (error) => {
      // Si no hay respuesta del servidor, podr√≠a ser un error de red
      if (!error.response) {
        console.error('‚ùå [Axios] Error de red:', error.message);
        return Promise.reject({
          isNetworkError: true,
          message: 'No se pudo conectar al servidor. Verifica tu conexi√≥n a internet.'
        });
      }

      const originalRequest = error.config;
      console.error('‚ùå [Axios] Error en la respuesta:', {
        url: originalRequest.url,
        status: error.response.status,
        statusText: error.response.statusText,
        method: originalRequest.method.toUpperCase(),
        isRetry: !!originalRequest._retry
      });
      
      // Si el error es 401 (No autorizado) y no es una solicitud de renovaci√≥n de token
      if (error.response.status === 401 && !originalRequest._retry) {
        // Si es una solicitud a la API de autenticaci√≥n, no intentar renovar
        if (originalRequest.url.includes('/api/auth/')) {
          console.log('üîê [Axios] Error de autenticaci√≥n en endpoint de autenticaci√≥n');
          
          // Limpiar credenciales locales
          localStorage.removeItem('authToken');
          localStorage.removeItem('refreshToken');
          localStorage.removeItem('user');
          
          // Redirigir al login si no estamos ya en esa p√°gina
          if (window.location.pathname !== '/login') {
            console.log('üîÑ [Axios] Redirigiendo a /login desde interceptor');
            navigate('/login', { 
              replace: true, 
              state: { 
                from: window.location.pathname,
                error: 'Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.'
              } 
            });
          }
          
          return Promise.reject({
            isAuthError: true,
            message: 'Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.'
          });
        }
        
        // Marcar como reintentado
        originalRequest._retry = true;
        
        try {
          // Intentar renovar el token si es posible
          const refreshToken = localStorage.getItem('refreshToken');
          if (refreshToken) {
            console.log('üîÑ [Axios] Intentando renovar el token de acceso...');
            
            // Usar axios directamente para evitar el interceptor
            const response = await axios({
              method: 'post',
              url: `${API_URL}/api/auth/refresh-token`,
              data: { refreshToken },
              headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
              },
              // Evitar redirecciones autom√°ticas
              maxRedirects: 0,
              validateStatus: null
            });
            
            console.log('üîÑ [Axios] Respuesta de renovaci√≥n de token:', {
              status: response.status,
              data: response.data ? 'Datos recibidos' : 'Sin datos'
            });
            
            if (response.status === 200 && response.data.token) {
              const { token, user } = response.data;
              console.log('‚úÖ [Axios] Token renovado exitosamente');
              
              // Actualizar el token en el almacenamiento local
              localStorage.setItem('authToken', token);
              if (user) {
                localStorage.setItem('user', JSON.stringify(user));
              }
              
              // Actualizar el encabezado de autorizaci√≥n
              originalRequest.headers.Authorization = `Bearer ${token}`;
              
              console.log('üîÑ [Axios] Reintentando solicitud original:', originalRequest.url);
              // Reintentar la solicitud original con el nuevo token
              return api(originalRequest);
            } else {
              console.warn('‚ö†Ô∏è [Axios] No se pudo renovar el token:', response.data?.message || 'Error desconocido');
              throw new Error('No se pudo renovar la sesi√≥n');
            }
          }
        } catch (refreshError) {
          console.error('‚ùå [Axios] Error al renovar el token:', refreshError);
          
          // Limpiar credenciales locales
          localStorage.removeItem('authToken');
          localStorage.removeItem('refreshToken');
          localStorage.removeItem('user');
          
          // Redirigir al login si no estamos ya en esa p√°gina
          if (window.location.pathname !== '/login') {
            console.log('üîÑ [Axios] Redirigiendo a /login desde error de renovaci√≥n de token');
            navigate('/login', { 
              replace: true, 
              state: { 
                from: window.location.pathname,
                error: 'Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.'
              } 
            });
          }
          
          return Promise.reject({
            isAuthError: true,
            message: 'Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.'
          });
        }
        
        // Si llegamos aqu√≠, no se pudo renovar el token o no hay refreshToken
        console.log('No se pudo renovar el token, cerrando sesi√≥n...');
        
        // Limpiar datos de autenticaci√≥n
        localStorage.removeItem('authToken');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('user');
        localStorage.removeItem('userRole');
        localStorage.removeItem('teacherId');
        
        // Redirigir al login solo si no estamos ya en la p√°gina de login
        if (navigate && window.location.pathname !== '/login') {
          console.log('Redirigiendo a la p√°gina de login...');
          navigate('/login', { 
            state: { 
              message: 'Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.',
              from: window.location.pathname 
            },
            replace: true
          });
        }
      }
      
      // Manejar otros c√≥digos de error
      switch (error.response.status) {
        case 403:
          console.warn('‚õî [Axios] Acceso denegado (403) para:', originalRequest.url);
          error.message = 'No tienes permiso para acceder a este recurso.';
          error.isForbidden = true;
          break;
          
        case 404:
          console.warn('üîç [Axios] Recurso no encontrado (404):', originalRequest.url);
          error.message = 'El recurso solicitado no fue encontrado.';
          error.isNotFound = true;
          break;
          
        case 500:
          console.error('üí• [Axios] Error interno del servidor (500)');
          error.message = 'Ocurri√≥ un error en el servidor. Por favor, int√©ntalo de nuevo m√°s tarde.';
          error.isServerError = true;
          break;
          
        default:
          console.error(`‚ö†Ô∏è [Axios] Error ${error.response.status}:`, error.message);
          error.message = error.response.data?.message || `Error en la solicitud: ${error.response.status} ${error.response.statusText}`;
      }
      
      // Agregar informaci√≥n adicional al error
      error.responseData = error.response.data;
      error.requestUrl = originalRequest.url;
      error.requestMethod = originalRequest.method;
      
      // Para errores de autenticaci√≥n que no se manejaron antes
      if (error.response.status === 401) {
        error.isAuthError = true;
        error.message = 'Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.';
        
        // Limpiar credenciales locales
        localStorage.removeItem('authToken');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('user');
        
        // Redirigir al login si no estamos ya en esa p√°gina
        if (window.location.pathname !== '/login') {
          console.log('üîÑ [Axios] Redirigiendo a /login desde manejo de error 401');
          navigate('/login', { 
            replace: true, 
            state: { 
              from: window.location.pathname,
              error: error.message
            } 
          });
        }
      }

      // Rechazar la promesa con el error mejorado
      return Promise.reject(error);
    }
  );
};

export default api;
